<!DOCTYPE html>
<html>
	<head>
		<title>States in Motion: Income per Capita</title>
		<meta name="description" content="Income">
		<link href='http://fonts.googleapis.com/css?family=Roboto:400,300italic,300,100italic,100,400italic,500italic,500,700,700italic,900,900italic' rel='stylesheet' type='text/css'>
		<link rel="stylesheet" type="text/css" href="css/bar.css"/>
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
		<script src="http://d3js.org/d3.v3.min.js"></script>
		<script src="http://edsource.org/wp-content/js/underscore-min.js"></script>
	</head>
	<body>

	<div id="main-wrapper" class="sr-graphic">
		<div id="content">
			<div id="chart"></div>	
		</div>
		<div id="selection"></div> 
	</div> 

	<svg width="10000" height="10000">
		<rect x="0" y="0" height="100" width="20", fill="blue" transform="rotate(45, 100, 100)"></rect>
	</svg>

	</body>
</html>

<script>

	//base functions
	var chartFunctions = {
		highlightBar:function(){
			var current = $(this); 
			var state = current.attr("state");

			//append label
			var clicked = $("#selection p[state='"+state+"']").attr("clicked");
			if (clicked === "false"){
				//var where = _.indexOf(states, state);
				//var position = parseFloat(endPoints[where]) - 2;
				//$("#main-wrapper").append("<span class=\"labels\" state=\""+state+"\" style=\"top:"+ position + "px;\">" + state + "</span>");
				//$(".label[state='"+ state +"']").insertBefore("#selection");
				//highlight and up front
				current.css("fill", "#4169E1");
			}
		},
		unhightlightBar:function(){
			var current = $(this); 
			var state = current.attr("state");

			//remove label abd highlight
			var clicked = $("#selection p[state='"+state+"']").attr("clicked");
			if (clicked === "false"){
				current.css("fill", "#e2e2e2");
				//$("span[state='"+ state +"']").remove();
			}

		},
		setDefaults:function(){
			chart = d3.select("#chart").append("svg:svg").attr("width", w).attr("height", h).append("svg:g");

		},
		drawChart:function(){
			//Set Scales
			yScale = d3.scale.linear()
				.domain([startData, endData])
				.range([0 + margin.top, h - margin.bottom]);
			

			//create bars
			chart.selectAll("rect")
				.data(firstPlot)
				.enter()
				.append("rect")
				.attr("x", function(d, i){
					return (i * (540/firstPlot.length)) + 62
				})
				.attr("y", function(d, i){
					return (h - yScale(d));
				})
				.attr("width", 8.58823552941)
				.attr("height", function(d){
					return yScale(d) - 30
					
				})
				.on("mouseover", chartFunctions.highlightBar)
				.on("mouseleave", chartFunctions.unhightlightBar)
				
			//meta data for bars
			for (i=0 ; i < states.length ; i++){
				$("#chart rect:eq("+i+")").attr("state", states[i]).attr("clicked","false").attr("data", firstPlot[i]);
			}
			
			//Create Axes				
			chart.append("svg:line")
				.attr("x1", 60)
				.attr("y1", h - 30)
				.attr("x2", 600)
				.attr("y2", h - 30)
				.attr("class", "axis"); //X-Axis
			chart.append("svg:line")
				.attr("x1", 60)
				.attr("y1", yScale(startData))
				.attr("x2", 60)
				.attr("y2", yScale(endData))
				.attr("class", "axis"); //Y-Axis
				
			//Move Axes to Top//
			$("svg line:eq(0)")
				.add("svg line:eq(1)")
				.detach()
				.insertAfter("#chart svg g");
				
		

			// Y Axis Labels //
			chart.selectAll(".yLabel")
				.data(yScale.ticks(4))
				.enter().append("svg:text")
				.attr("class", "yLabel")
				.text(String)
				.attr("x", 50)
				.attr("y", function(d) {
				return yScale(d)
			}).attr("text-anchor", "end").attr("dy", 3);

			utilityFunctions.churnLargeNumbers(true);
			
			// Y Axis Ticks //
			chart.selectAll(".yTicks")
				.data(yScale.ticks(4))
				.enter()
				.append("svg:line")
				.attr("class", "yTicks")
				.attr("y1", function(d) {
					return yScale(d);
			}).attr("x1", 55).attr("y2", function(d) {
					return yScale(d);
			}).attr("x2", 60);
		
		},
		populateLabels:function(){
			for (i=0 ; i < states.length ; i++){
				$("#selection").append("<p state=\""+states[i]+"\"clicked=\"false\">" + states[i] + "</p>");
				$("#selection p:eq("+i+")").on("click", function(){
					var clicked = $(this).attr("clicked");
					var thisState = $(this).text();
					if (clicked === "false"){
						//determine position
						//var where = _.indexOf(states, thisState);
						//var position = parseFloat(endPoints[where]) - 2;
						//background and up front
						$(this).css("background", "#ddd").attr("clicked","true");
						$("#chart rect[state='"+ thisState +"']").css("fill","#4169E1");
						//toggle layer
						//$("#main-wrapper").append("<span class=\"labels\" state=\""+thisState+"\" style=\"top:"+ position + "px;\">" + thisState + "</span>");
						//$(".label[state='"+ thisState +"']").insertBefore("#selection")
					}
					else {
						//background
						$(this).css("background", "#fff").attr("clicked","false");
						$("#chart rect[state='"+ thisState +"']").css("fill","#e2e2e2");
						//remove label
						//$("span[state='"+ thisState +"']").remove();
					}
				});
			}
		},
	}

	//Globals//
	var dataType = $("meta").attr("content");
	var	w = 600,h = 400, barPadding = 2, startYear = 0,endYear = 0,yearPosition = 0, startData, endData, chart,xScale,yScale,line,
		margin = {
			all:-1,
			left:70,
			right:15,
			top:30,
			bottom:30
		},
		padding = 60;
	var barData = [], states = [], endPoints = [], firstPlot = [];
	switch(dataType){
		case "Income":
			startYear = 1970;
			endYear = 2013;
			yearPosition = 1970;
			startData = 0;
			endData = 80000;
			chartFunctions.setDefaults();
			break;
	}

	var startEnd = {}

	var utilityFunctions = {
		commaSeparateNumber:function(val){
		    while (/(\d+)(\d{3})/.test(val.toString())){
		      val = val.toString().replace(/(\d+)(\d{3})/, '$1'+','+'$2');
		    }
		    return val;
		},
		churnLargeNumbers:function(line){
			var countX = $(".xLabel").length;
			var countY = $(".yLabel").length;
			var xLabels = [], xTemp = [], yLabels = [], yTemp = [];

			if (!line){
				for (i=0 ; i < countX ; i++){
					xTemp[i] = $(".xLabel:eq("+i+")").text();
					xLabels[i] = utilityFunctions.commaSeparateNumber(xTemp[i]);
					$(".xLabel:eq("+i+")").text(xLabels[i]);
				}
			}

			for (i=0 ; i < countY ; i++){
				yTemp[i] = $(".yLabel:eq("+i+")").text();
				yLabels[i] = utilityFunctions.commaSeparateNumber(yTemp[i]);
				$(".yLabel:eq("+i+")").text(yLabels[i]);
			}

		}
	}
	//Populate Lines and Data//
	switch(dataType){
		case "Income":
			d3.text('data/income.csv', 'text/csv', function(text) {
				var thisData = d3.csv.parseRows(text);
				for (i = 1; i < thisData.length; i++) {
					barData[i-1] = thisData[i].slice(1,45);
					
					//populate state labels
					states[i-1] = thisData[i][0];
/*
				
					//populate end points for each line
					var ii = i - 1;
					var temp = $("#chart path:eq("+ii+")").attr("d");
					var split = temp.split(",");
					var end = split.length - 1;
					endPoints[ii] = split[end];*/
					firstPlot[i-1] = parseInt(barData[i-1][0]);
				}	
				
				chartFunctions.populateLabels();
				chartFunctions.drawChart();
			});
			break;
	}

	
</script>